<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chattr</title>

    <script type="application/javascript" src="../msgr-client-js/msgr-client.js"></script>
</head>
<body>

<h1>Chattr messages</h1>
<span id="deviceIdLabel">Device:</span><br/>
<input id="deviceId" type="text" title="Username" aria-labelledby="deviceIdLabel"><br/>
<span id="usernameLabel">Username:</span><br/>
<input id="username" type="text" title="Username" aria-labelledby="usernameLabel"><br/>
<button id="connect">Connect</button>

<h3 id="connected">Status: Disonnected</h3>

<h2>Messages:</h2>
<ul id="msgs">
</ul>

<h2>Write a message:</h2>
<span id="targetLabel">Device:</span><br/>
<input id="device" type="text" title="Device" aria-labelledby="targetLabel"><br/>

<span id="messageLabel">Message:</span><br/>
<textarea id="messageArea" title="Message" aria-labelledby="messageLabel"></textarea><br/>

<button id="sendMsg">Send</button>

<script type="application/javascript">
    let notificationOk = false;

    if (!("Notification" in window)) {
        alert("Notifications not supported in browser");
    } else if (Notification.permission === "granted") {
        notificationOk = true;
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission(function (permission) {
            if (permission === "granted") {
                notificationOk = true;
            }
        });
    }

    document.getElementById("sendMsg").onclick = () => {
        let device = document.getElementById("device").value;
        let text = document.getElementById("messageArea").value;

        let message = new DataMessageDto({text: text, from: MSGR.userName}, null, null, [device], MSGR.deviceId, MSGR.userName);
        MSGR.send(message);

        appendToMessages(MSGR.userName, text);
    };

    function makeNotification(title, body) {
        let params = {
            body: body
        };
        return new Notification(title, params)
    }

    function appendToMessages(sender, text) {
        let newLine = document.createElement("li");

        let dateText = document.createTextNode(new Date().toLocaleString() + " @" + sender);
        let dateElem = document.createElement("b");
        dateElem.appendChild(dateText);

        newLine.appendChild(dateElem);
        newLine.appendChild(document.createTextNode(": " + text));

        document.getElementById("msgs").appendChild(newLine);
    }

    document.getElementById("connect").onclick = () => {
        document.getElementById("connected").textContent = "Status: Connecting...";
        let deviceId = document.getElementById("deviceId");
        deviceId.readOnly = true;
        MSGR.deviceId = deviceId.value;

        let username = document.getElementById("username");
        username.readOnly = true;
        MSGR.userName = username.value;

        MSGR.onSuccess = () => {
            console.log("success. Device ID: " + MSGR.deviceId + ", User ID:" + MSGR.userId);
            appendToMessages("Server", "Connected");
            document.getElementById("connected").textContent = "Status: Connected";

            deviceId.value = MSGR.deviceId;
            username.value = MSGR.userName;
        };

        MSGR.onClose = () => {
            appendToMessages("Disconnected");
            document.getElementById("connected").textContent = "Status: Disconnected";
            deviceId.readOnly = false;
            username.readOnly = false;
        };

        MSGR.onFailure = () => {
            appendToMessages("Error occured");
            document.getElementById("connected").textContent = "Status: Disconnected";
        };

        MSGR.onNotification = (title, body) => {
            appendToMessages(title + ": " + body);
            if (notificationOk) {
                let notification = makeNotification(title, body);
            }
        };

        MSGR.onDataMessage = (payload) => {
            appendToMessages(payload.from, payload.text);
        };

        MSGR.init();
    };
</script>

</body>
</html>
